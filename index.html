<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
<title>SYA</title>

<!-- ==========================
     PWA CONFIG
     ========================== -->
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- ==========================
     FUENTES / ICONOS
     ========================== -->
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300" rel="stylesheet"/>

<style>
:root{
  /* Colores base */
  --primary:#ffa0e5;
  --text:#fff;
  --glass:rgba(0,0,0,.4);

  /* Paleta de notificación (badge + sombras) */
  --notif-bg:#ff3b30; /* rojo iOS */
  --notif-shadow:rgba(255,59,48,0.45);
}

/* -------------------------
   GLOBAL / RESET
   ------------------------- */
*{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;user-select:none;}
html,body{
  width:100%;height:100dvh;min-height:100vh;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  color:var(--text);overflow:hidden;background:#000;
  -webkit-text-size-adjust:100%;
}
.material-symbols-outlined{font-size:2rem;}

/* -------------------------
   LOCKSCREEN
   ------------------------- */
#lockScreen{
  position:fixed;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;
  background:url("momentos/foto0.JPG") no-repeat center/cover;
  transition:transform .7s ease-in-out;z-index:30;
}
#lockScreen::after{content:"";position:absolute;inset:0;background:rgba(0,0,0,.35);pointer-events:none;}
.lockContent{
  position:relative;display:flex;flex-direction:column;align-items:center;z-index:1;width:100%;
  padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);
}

/* Corazón + badge pegado */
.heart{
  position:relative;
  font-size:3rem;margin-bottom:1rem;animation:heartbeat 1.8s infinite;
}
@keyframes heartbeat{0%,100%{transform:scale(1);}50%{transform:scale(1.18);}}

/* Burbuja de nuevos al lado del corazón */
#newBadge{
  position:absolute;top:-8px;right:-8px;
  background:var(--notif-bg);color:#fff;font-size:.78rem;font-weight:700;
  border-radius:999px;padding:.15rem .45rem;display:none;opacity:0;transform:scale(.5);
  transition:transform .36s cubic-bezier(.2,.9,.3,1), opacity .36s;
  pointer-events:none;
}
#newBadge.show{display:inline-block;opacity:1;transform:scale(1);}

/* Mensaje + dots + keypad */
#message{font-size:1.05rem;margin-bottom:1rem;min-height:1.4rem;opacity:0;transition:opacity .3s;}
#message.show{opacity:1;}
#pinDots{display:flex;gap:.5rem;margin-bottom:1rem;}
.dot{width:.9rem;height:.9rem;border-radius:50%;border:2px solid var(--text);background:transparent;transition:.18s;}
.dot.filled{background:var(--text);}
#keypad{
  display:grid;grid-template-columns:repeat(3,min(20vw,70px));gap:1rem;justify-content:center;
}
.key{
  width:min(20vw,70px);height:min(20vw,70px);border-radius:50%;
  background:var(--glass);color:var(--text);display:flex;align-items:center;justify-content:center;
  font-size:2rem;cursor:pointer;backdrop-filter:blur(6px);transition:transform .12s;
  position:relative;overflow:hidden;touch-action:manipulation;
}
.key:active{transform:scale(.94);}

/* -------------------------
   TOPBAR (tras desbloquear)
   ------------------------- */
#topbar{
  position:fixed;top:env(safe-area-inset-top,0);left:0;right:0;z-index:25;
  display:none;justify-content:center;padding:.6rem 1rem;
}
.searchWrap{
  flex:1;max-width:700px;display:flex;align-items:center;gap:.5rem;
  background:var(--glass);backdrop-filter:blur(6px);border-radius:999px;padding:.35rem .75rem;position:relative;
}
.searchWrap .icon{font-size:1.35rem;opacity:.9;}
#slideSearch{flex:1;border:none;outline:none;background:transparent;color:var(--text);font-size:1rem;padding:.35rem 0;}
.counter{font-variant-numeric:tabular-nums;opacity:.9;white-space:nowrap;}
#refreshBtn{
  background:var(--glass);border:none;border-radius:50%;width:36px;height:36px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;margin-left:.5rem;color:var(--text);
  transition:transform .22s,opacity .22s;
}
#refreshBtn:active{transform:scale(.94);}
#refreshBtn.refreshing{transform:rotate(360deg) scale(1.03);transition:transform .6s ease-in-out;}

/* -------------------------
   STORIES
   ------------------------- */
#stories{
  position:fixed;inset:0;background:#000;overflow:hidden;
  transform:translateY(100%);transition:transform .7s ease-in-out;z-index:20;
}
#track{
  width:100%;height:100%;
  will-change:transform; /* ♻️ optimización GPU */
  touch-action:none;display:block;
  transform:translate3d(0,0,0);
}
.story{
  height:100dvh;width:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;
  position:relative;padding:2rem;background-size:cover;background-position:center;will-change:transform;
}
.story::after{
  content:"";position:absolute;inset:0;background:linear-gradient(to bottom,#0000004d,#000000e6);
  pointer-events:none;transition:background .28s;
}
.storyContent{position:relative;z-index:1;max-width:900px;margin:0 auto;padding:0 1rem;}
.story h2{font-family:"Dancing Script",cursive;font-size:2rem;margin-bottom:.5rem;}
.story .date{font-size:1rem;opacity:.85;margin-bottom:1rem;}
.story p{font-size:1.06rem;line-height:1.45;}
@media(min-width:768px){.story h2{font-size:2.4rem}.story p{font-size:1.15rem}}

/* 🎯 Marca visual de NUEVA historia (1ª vista mantiene, 2ª vista se elimina) */
.story.newItem::after{
  background:linear-gradient(to bottom, rgba(255,59,48,0.32), rgba(0,0,0,0.92));
  box-shadow: inset 0 0 40px var(--notif-shadow);
}

/* Feedback visual al refrescar */
.track-refreshing {
  filter: brightness(.98) saturate(.98);
  transition: filter .35s ease;
}
</style>
</head>
<body oncontextmenu="return false;">

<!-- -------------------------
     LOCKSCREEN
     ------------------------- -->
<div id="lockScreen">
  <div class="lockContent">
    <!-- ❤️ Corazón con badge pegado arriba-derecha -->
    <span class="material-symbols-outlined heart">
      favorite
      <span id="newBadge" aria-hidden="true"></span>
    </span>

    <div id="message" class="show">Ingrese código</div>
    <div id="pinDots"></div>
    <div id="keypad"></div>
  </div>
</div>

<!-- -------------------------
     TOPBAR (tras desbloquear)
     ------------------------- -->
<div id="topbar">
  <div class="searchWrap">
    <span class="material-symbols-outlined icon">search</span>
    <input id="slideSearch" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Buscar recuerdo..."/>
    <div class="counter">
      <span id="currentIdx">1</span> / <span id="totalIdx">1</span>
    </div>
    <!-- Aquí va REFRESH (en el lugar donde antes estaba el badge) -->
    <button id="refreshBtn" class="material-symbols-outlined" title="Refrescar">refresh</button>
  </div>
</div>

<!-- -------------------------
     STORIES
     ------------------------- -->
<div id="stories" aria-label="Historias de pareja">
  <div id="track" role="list"></div>
</div>

<script>
/* ===========================
   CONFIG / STATE
   =========================== */
const PASSWORD_HASH = "4908ef154f13f297da224aceaa78fbbedfc12adf625611d8972b148c43c9e46d"; // hash SHA-256 del PIN correcto
const PIN_LENGTH = 6;
const RECUERDOS_JSON = "recuerdos.json"; // ruta del JSON con historias

let recuerdos = [], N = 0;
let pageH = 0;
/* pos es el índice dentro del track con clones:
   0 = clone del último, 1..N = reales, N+1 = clone del primero */
let pos = 1;

let dragging = false, animating = false;
let startY = 0, baseY = 0;
let rafId = 0, latestDelta = 0;  // loop de arrastre para suavidad
let velocity = 0, lastMoveTime = 0, lastMoveY = 0;

let lastKnownCount = parseInt(localStorage.getItem("lastCount") || "0"); // historias que ya existían
let builtOnce = false; // para no sobre-registrar listeners

/* ===========================
   ELEMENTOS
   =========================== */
const lockScreen = document.getElementById("lockScreen");
const dotsWrap = document.getElementById("pinDots");
const keypad = document.getElementById("keypad");
const msg = document.getElementById("message");
const topbar = document.getElementById("topbar");
const track = document.getElementById("track");
const stories = document.getElementById("stories");
const slideSearch = document.getElementById("slideSearch");
const currentIdxEl = document.getElementById("currentIdx");
const totalIdxEl = document.getElementById("totalIdx");
const newBadge = document.getElementById("newBadge");
const refreshBtn = document.getElementById("refreshBtn");

/* ===========================
   DOTS PARA PIN
   =========================== */
const dotEls = [];
for(let i=0;i<PIN_LENGTH;i++){
  const d = document.createElement("div");
  d.className = "dot";
  dotsWrap.appendChild(d);
  dotEls.push(d);
}

/* ===========================
   MENSAJE + FECHA
   =========================== */
function showMessage(text, shake=false){
  msg.classList.remove("show");
  setTimeout(()=>{
    msg.textContent = text;
    msg.classList.add("show");
    if(shake){ msg.classList.add("shake"); setTimeout(()=>msg.classList.remove("shake"),420); }
  },120);
}
function formateaFechaES(iso){
  try{
    const d = new Date(iso + "T12:00:00");
    const m = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
    return `${d.getDate()} de ${m[d.getMonth()]} del ${d.getFullYear()}`;
  }catch(_){ return iso; }
}

/* ===========================
   KEYPAD Y PIN
   =========================== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function attachKey(el,onPress){
  const down=e=>{ e.preventDefault(); el.classList.add("active"); onPress(); };
  const up=()=> el.classList.remove("active");
  el.addEventListener("pointerdown",down,{passive:false});
  el.addEventListener("pointerup",up);
  el.addEventListener("pointercancel",up);
  el.addEventListener("pointerleave",up);
}
function renderKeypad(){
  keypad.innerHTML = "";
  shuffle([...Array(10).keys()]).forEach(n=>{
    const k=document.createElement("div"); k.className="key"; k.textContent=n;
    attachKey(k,()=>enterDigit(n));
    keypad.appendChild(k);
  });
  const del=document.createElement("div"); del.className="key material-symbols-outlined"; del.textContent="backspace";
  attachKey(del, deleteDigit); keypad.appendChild(del);
}
renderKeypad();

let input="";
async function hashPassword(pwd){
  const enc = new TextEncoder().encode(pwd);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
function enterDigit(n){
  if(input.length>=PIN_LENGTH) return;
  input += String(n);
  dotEls[input.length-1].classList.add("filled");
  if(input.length===PIN_LENGTH) checkPassword();
}
function deleteDigit(){
  if(input.length>0){
    dotEls[input.length-1].classList.remove("filled");
    input = input.slice(0,-1);
  }
}
async function checkPassword(){
  const h = await hashPassword(input);
  if(h === PASSWORD_HASH){
    showMessage("✔ Desbloqueado!");
    lockScreen.style.transform = "translateY(-100%)";
    stories.style.transform = "translateY(0)";
    topbar.style.display = "flex";
    /* 🔑 IMPORTANTE:
       No reconstruimos aquí. El build inicial (DOMContentLoaded) ya dejó
       preparado el badge y los .newItem. Así no “pisamos” la marca. */
  }else{
    input="";
    dotEls.forEach(d=>d.classList.remove("filled"));
    renderKeypad();
    showMessage("Código incorrecto", true);
  }
}

/* ===========================
   STORIES: CREACIÓN
   =========================== */
function crearStory(item, originalIndex){
  const sec = document.createElement("section");
  sec.className = "story";
  sec.style.backgroundImage = `url('${item.fondo}')`;
  sec.dataset.original = String(originalIndex);
  sec.innerHTML = `
    <div class="storyContent">
      <h2>${item.titulo}</h2>
      <div class="date">${formateaFechaES(item.fecha)}</div>
      <p>${item.descripcion}</p>
    </div>`;
  return sec;
}

/* ===========================
   BUILD + MEDIDAS
   =========================== */
function buildTrack(){
  track.innerHTML = "";
  if(N===0) return;
  const first = crearStory(recuerdos[0], 0);
  const last  = crearStory(recuerdos[N-1], N-1);
  /* Clones para loop infinito: arriba = último, abajo = primero */
  track.appendChild(last.cloneNode(true));            // index 0 (clone up)
  recuerdos.forEach((it,idx)=> track.appendChild(crearStory(it, idx))); // index 1..N (reales)
  track.appendChild(first.cloneNode(true));           // index N+1 (clone down)
}
function measure(){ pageH = window.innerHeight || document.documentElement.clientHeight; }
function setTransformY(y, withAnim=false){
  track.style.transition = withAnim ? "transform .35s cubic-bezier(.22,.61,.36,1)" : "none";
  track.style.transform = `translate3d(0,${y}px,0)`; // GPU
}

/* ===========================
   ÍNDICES Y CONTADOR
   =========================== */
function realIndexFromPos(){ // 0..N-1
  let r = pos - 1;
  if(r < 0) r = 0;
  if(r >= N) r = N-1;
  return r;
}
function updateCounterFromPos(){
  const realIdx = realIndexFromPos();
  currentIdxEl.textContent = String(realIdx+1);
  localStorage.setItem("lastSeenIndex", realIdx);

  // ✅ Usamos el elemento en la posición actual (incluye clones) para no fallar con duplicados
  const currentEl = track.children[pos];
  if(currentEl && currentEl.classList.contains("newItem")){
    if(currentEl.dataset.seen === "1"){
      // 2ª vez que se ve → quitar marca
      currentEl.classList.remove("newItem");
      // Si ya no quedan nuevos en los REALES, quitamos badge y actualizamos lastCount
      const anyNewLeft = [...track.children].slice(1, N+1).some(el=>el.classList.contains("newItem"));
      if(!anyNewLeft){
        newBadge.classList.remove("show");
        newBadge.style.display = "none";
        localStorage.setItem("lastCount", String(N)); // ya todo visto
      }
    }else{
      // 1ª vez que se ve → marcar como vista una vez pero mantener rojito
      currentEl.dataset.seen = "1";
    }
  }
}

/* ===========================
   NORMALIZACIÓN DE CLONES
   =========================== */
function goToPos(p, animate=true){
  pos = p;
  setTransformY(-pos*pageH, animate);
  updateCounterFromPos();
}
function normalizeIfClone(){
  if(pos === 0){               // está en clone de arriba → saltar al real al fondo
    pos = N;
    setTransformY(-pos*pageH, false);
  }else if(pos === N+1){       // está en clone de abajo → saltar al real del inicio
    pos = 1;
    setTransformY(-pos*pageH, false);
  }
  updateCounterFromPos();
}

/* ===========================
   DRAG / WHEEL (fluidez)
   =========================== */
function onPointerDown(e){
  if(animating) return;
  dragging = true;
  startY = e.clientY;
  baseY = -pos*pageH;
  latestDelta = 0;
  lastMoveTime = Date.now();
  lastMoveY = e.clientY;
  velocity = 0;
  track.style.transition = "none";
  e.preventDefault();

  const loop = ()=>{
    if(!dragging) return;
    // amortiguación sutil
    const y = baseY + latestDelta*0.98;
    track.style.transform = `translate3d(0,${y}px,0)`;
    rafId = requestAnimationFrame(loop);
  };
  rafId = requestAnimationFrame(loop);
}
function onPointerMove(e){
  if(!dragging) return;
  latestDelta = e.clientY - startY;
  const now = Date.now();
  velocity = (e.clientY - lastMoveY) / Math.max(16, now - lastMoveTime);
  lastMoveTime = now;
  lastMoveY = e.clientY;
}
function onPointerUp(e){
  if(!dragging) return;
  dragging = false;
  cancelAnimationFrame(rafId);

  const dy = e.clientY - startY;
  const v  = velocity;

  // Umbral por desplazamiento o inercia
  const shouldFlip = Math.abs(dy) > 50 || Math.abs(v) > 0.35;
  if(shouldFlip){
    if(dy > 0) pos--; else pos++;
  }
  animating = true;
  goToPos(pos, true);
  track.addEventListener("transitionend", onTransitionEnd, {once:true});
}
function onTransitionEnd(){
  animating = false;
  normalizeIfClone();
}

// soporte wheel en desktop (rate-limited)
let lastWheel=0;
function onWheel(e){
  const now=Date.now();
  if(animating || now - lastWheel < 300) return;
  lastWheel = now;
  if(e.deltaY > 0) pos++; else pos--;
  animating = true; goToPos(pos, true);
  track.addEventListener("transitionend", onTransitionEnd, {once:true});
}

/* ===========================
   SALTO DIRECTO POR NÚMERO
   =========================== */
function goToIndexReal(n){
  if(!N) return;
  n = Math.max(1, Math.min(N, n|0));
  pos = n; // porque 1..N son reales
  animating = true; goToPos(pos, true);
  track.addEventListener("transitionend", onTransitionEnd, {once:true});
}

/* ===========================
   FETCH + BUILD + NUEVOS
   =========================== */
function preloadFondos(arr){ arr.forEach(x=>{ const img=new Image(); img.src=x.fondo; }); }

async function fetchAndBuild(silent=false){
  let data;
  try{
    const res = await fetch(RECUERDOS_JSON, {cache:"no-store"});
    data = await res.json();
  }catch(_){
    data = [{titulo:"Hola",fecha:"2025-08-21",descripcion:"Agrega recuerdos.json",fondo:"momentos/foto1.jpg"}];
  }

  recuerdos = data;
  N = recuerdos.length;
  totalIdxEl.textContent = String(Math.max(1,N));
  preloadFondos(recuerdos);

  buildTrack();
  measure();

  // Restaurar última posición vista (lastSeenIndex)
  let saved = parseInt(localStorage.getItem("lastSeenIndex") || "0");
  if(isNaN(saved) || saved<0 || saved>=N) saved = 0;
  pos = saved + 1; // 1..N
  setTransformY(-pos*pageH, false);

  // Marcar historias NUEVAS comparando con lastCount
  lastKnownCount = parseInt(localStorage.getItem("lastCount") || "0");
  const hasNew = N > lastKnownCount;

  // Marcar solo en los REALES (1..N)
  const nodes = [...track.children].slice(1, N+1);
  nodes.forEach((el, iReal)=>{
    const originalIdx = iReal; // 0..N-1
    if(hasNew && originalIdx >= lastKnownCount) el.classList.add("newItem");
    else el.classList.remove("newItem");
    el.dataset.seen = ""; // reset del flag de vista (se controla por sesión)
  });

  // Badge en lockscreen (pegado al corazón)
  if(hasNew){
    const diff = N - lastKnownCount;
    newBadge.textContent = String(diff);
    newBadge.classList.add("show");
    newBadge.style.display = "inline-block";
  }else{
    newBadge.classList.remove("show");
    newBadge.style.display = "none";
  }

  updateCounterFromPos();

  if(!silent){
    track.classList.add("track-refreshing");
    setTimeout(()=> track.classList.remove("track-refreshing"), 320);
  }

  // Listeners una sola vez (track es el mismo nodo siempre)
  if(!builtOnce){
    builtOnce = true;
    track.addEventListener("pointerdown", onPointerDown);
    track.addEventListener("pointermove", onPointerMove);
    track.addEventListener("pointerup", onPointerUp);
    stories.addEventListener("wheel", onWheel, {passive:true});

    slideSearch.addEventListener("change", ()=>{
      const v = parseInt(slideSearch.value, 10);
      if(!isNaN(v)) goToIndexReal(v);
    });
    slideSearch.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        const v = parseInt(slideSearch.value, 10);
        if(!isNaN(v)) goToIndexReal(v);
      }
    });

    window.addEventListener("resize", ()=>{
      const realIdx = realIndexFromPos();
      measure();
      pos = realIdx + 1;
      setTransformY(-pos*pageH, false);
    });
  }
}

/* ===========================
   REFRESH
   =========================== */
refreshBtn.addEventListener("click", async ()=>{
  if(refreshBtn.classList.contains("refreshing")) return;
  refreshBtn.classList.add("refreshing");
  await fetchAndBuild(false);   // recarga JSON y re-aplica newItem / badge
  pos = 1;                      // volver al primero con animación
  animating = true; goToPos(pos, true);
  track.addEventListener("transitionend", ()=>{
    animating = false; normalizeIfClone();
    refreshBtn.classList.remove("refreshing");
  }, {once:true});
});

/* ===========================
   INIT
   =========================== */
document.addEventListener("DOMContentLoaded", async ()=>{
  await fetchAndBuild(true); // Construimos una vez (badge y newItem quedan listos en lockscreen)
});

/* ===========================
   ANTIZOOM iOS (calidad UX)
   =========================== */
document.addEventListener('gesturestart', e=>e.preventDefault());
document.addEventListener('gesturechange', e=>e.preventDefault());
document.addEventListener('gestureend', e=>e.preventDefault());
let lastTouchEnd=0;
document.addEventListener('touchend', e=>{
  const now=Date.now();
  if(now-lastTouchEnd<=300){ e.preventDefault(); } // doble tap zoom
  lastTouchEnd=now;
},{passive:false});
document.addEventListener('wheel', e=>{ if(e.ctrlKey){ e.preventDefault(); } }, {passive:false});

/* ===========================
   SERVICE WORKER
   =========================== */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').catch(console.error);
}
</script>
</body>
</html>